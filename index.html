<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sikkim Pay Fixation Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 py-10">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded px-8 py-6">
    <h2 class="text-2xl font-bold mb-4 text-center">Sikkim Government Pay Fixation Calculator</h2>
    <div id="message" class="hidden mb-4 p-4 rounded text-white"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block font-medium">Promotion Date</label>
        <input type="date" id="promotionDate" class="w-full p-2 border rounded" value="" />
        <script>
          document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('promotionDate').value = today.toISOString().split('T')[0];
          });
        </script>
      </div>
      <div>
        <label class="block font-medium">Current Pay Level</label>
        <select id="currentLevel" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-medium">Current Pay Cell</label>
        <select id="currentCell" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-medium">Promoted Pay Level</label>
        <select id="promotedLevel" class="w-full p-2 border rounded"></select>
      </div>
    </div>
    <div class="mt-6 text-center">
      <button id="calculateBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Calculate</button>
    </div>

    <div class="mt-8 text-sm text-gray-700 italic">
      <p><strong>Increment Rule:</strong> If promotion occurs between <u>2nd Jan to 1st July</u>, the next increment will be on <u>1st January</u> of the following year. If promotion occurs between <u>2nd July to 1st January</u>, the increment will be on <u>1st July</u> of the following year.</p>
    </div>

    <div id="dopResult" class="mt-8"></div>
    <div id="dniResult" class="mt-8"></div>
    <div id="recommendation" class="mt-8 text-lg font-semibold text-green-700"></div>
  </div>

  <script>
    let payMatrix = {};

    function showMessage(text, type = 'info') {
      const box = document.getElementById('message');
      box.className = `mb-4 p-4 rounded text-white ${type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
      box.textContent = text;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 4000);
    }

    function parseCSV(data) {
      Papa.parse(data, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(row => {
            const level = row.Level.trim();
            delete row.Level;
            payMatrix[level] = Object.values(row).map(val => parseInt(val, 10)).filter(v => !isNaN(v));
          });
          populateLevels();
        }
      });
    }

    function populateLevels() {
      const currentLevel = document.getElementById('currentLevel');
      const promotedLevel = document.getElementById('promotedLevel');
      currentLevel.innerHTML = promotedLevel.innerHTML = '';
      for (let level in payMatrix) {
        currentLevel.innerHTML += `<option value="${level}">${level}</option>`;
        promotedLevel.innerHTML += `<option value="${level}">${level}</option>`;
      }
      updateCells();
    }

    function updateCells() {
      const level = document.getElementById('currentLevel').value;
      const currentCell = document.getElementById('currentCell');
      currentCell.innerHTML = '';
      if (payMatrix[level]) {
        payMatrix[level].forEach((val, i) => {
          currentCell.innerHTML += `<option value="${i}">${i + 1} - ₹${val}</option>`;
        });
      }
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function getNextIncrementDate(date) {
      const month = date.getMonth();
      const year = date.getFullYear() + 1;
      return (month < 6 || (month === 6 && date.getDate() <= 1)) ? new Date(`${year}-01-01`) : new Date(`${year}-07-01`);
    }

    function incrementCell(level, currentCell, steps = 1) {
      if (!payMatrix[level]) return 0;
      return Math.min(currentCell + steps, payMatrix[level].length - 1);
    }

    function generateTimeline(startDate, level, startCell, incrementsCount) {
      const timeline = [];
      let currentDate = new Date(startDate);
      let currentCell = startCell;
      for (let i = 0; i <= incrementsCount; i++) {
        timeline.push({
          date: formatDate(currentDate),
          level: level,
          cell: currentCell + 1,
          pay: payMatrix[level][currentCell],
          explanation: i === 0 ? 'Starting pay' : 'Incremented pay'
        });

        const nextDate = getNextIncrementDate(currentDate);
        currentCell = incrementCell(level, currentCell, 1);
        currentDate = nextDate;
      }
      return timeline;
    }

    // Helper: returns the max pay entry for a given date in a timeline array
    function maxPayEntryOnDate(rows, date) {
      const entries = rows.filter(r => r.date === date);
      if (entries.length === 0) return null;
      return entries.reduce((maxEntry, current) => (current.pay > maxEntry.pay ? current : maxEntry), entries[0]);
    }

    function calculateFixation() {
      const promoDateStr = document.getElementById('promotionDate').value;
      if (!promoDateStr) return showMessage('Please enter the promotion date.', 'error');

      const promoDate = new Date(promoDateStr);
      const currLevel = document.getElementById('currentLevel').value;
      const currCell = parseInt(document.getElementById('currentCell').value);
      const promoLevel = document.getElementById('promotedLevel').value;
      const currPay = payMatrix[currLevel][currCell];

      // DoP logic
      const dopIncrCell = incrementCell(currLevel, currCell, 1);
      const dopIncrPay = payMatrix[currLevel][dopIncrCell];
      let dopFixCell = payMatrix[promoLevel].findIndex(p => p >= dopIncrPay);
      if (dopFixCell === -1) dopFixCell = payMatrix[promoLevel].length - 1;

      const dopTimeline = [];
      dopTimeline.push({date: formatDate(promoDate), level: currLevel, cell: currCell + 1, pay: currPay, explanation: 'Initial pay before promotion'});
      dopTimeline.push({date: formatDate(promoDate), level: currLevel, cell: dopIncrCell + 1, pay: dopIncrPay, explanation: '1 increment in current level'});
      dopTimeline.push({date: formatDate(promoDate), level: promoLevel, cell: dopFixCell + 1, pay: payMatrix[promoLevel][dopFixCell], explanation: 'Placed at equal or next higher in promoted level'});

      const dopFixDate = promoDate;
      const dopIncrements = 5;
      const dopIncrTimeline = generateTimeline(dopFixDate, promoLevel, dopFixCell, dopIncrements);
      dopIncrTimeline.shift();
      dopTimeline.push(...dopIncrTimeline);

      // DNI logic
      let dniInitialCell = payMatrix[promoLevel].findIndex(p => p >= currPay);
      if (dniInitialCell === -1) dniInitialCell = payMatrix[promoLevel].length - 1;

      const dniEffectiveDate = getNextIncrementDate(promoDate);
      const dniTwoIncrCell = incrementCell(currLevel, currCell, 2);
      const dniTwoIncrPay = payMatrix[currLevel][dniTwoIncrCell];

      let dniFixCell = payMatrix[promoLevel].findIndex(p => p >= dniTwoIncrPay);
      if (dniFixCell === -1) dniFixCell = payMatrix[promoLevel].length - 1;

      const dniTimeline = [];
      dniTimeline.push({date: formatDate(promoDate), level: promoLevel, cell: dniInitialCell + 1, pay: payMatrix[promoLevel][dniInitialCell], explanation: 'Initial placement in promoted level'});
      dniTimeline.push({date: formatDate(dniEffectiveDate), level: currLevel, cell: dniTwoIncrCell + 1, pay: dniTwoIncrPay, explanation: '2 increments in old level (annual + promotional)'});
      dniTimeline.push({date: formatDate(dniEffectiveDate), level: promoLevel, cell: dniFixCell + 1, pay: payMatrix[promoLevel][dniFixCell], explanation: 'Placed at next higher in promoted level'});

      const dniIncrements = 4;
      const dniIncrTimeline = generateTimeline(dniEffectiveDate, promoLevel, dniFixCell, dniIncrements);
      dniIncrTimeline.shift();
      dniTimeline.push(...dniIncrTimeline);

      // Render tables
      const renderTable = (title, rows) => {
        return `
          <h3 class="text-xl font-semibold mb-2">${title}</h3>
          <table class="w-full text-sm border mb-6">
            <thead>
              <tr>
                <th class="border px-2 py-1">Date</th>
                <th class="border px-2 py-1">Pay Level</th>
                <th class="border px-2 py-1">Cell</th>
                <th class="border px-2 py-1">Basic Pay (₹)</th>
                <th class="border px-2 py-1">Explanation</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => `<tr>
                <td class="border px-2 py-1">${r.date}</td>
                <td class="border px-2 py-1">${r.level}</td>
                <td class="border px-2 py-1">${r.cell}</td>
                <td class="border px-2 py-1">₹${r.pay.toLocaleString()}</td>
                <td class="border px-2 py-1">${r.explanation}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        `;
      };

      document.getElementById('dopResult').innerHTML = renderTable('Fixation from Date of Promotion (DoP)', dopTimeline);
      document.getElementById('dniResult').innerHTML = renderTable('Fixation from Date of Next Increment (DNI)', dniTimeline);

      // Date-wise pay comparison analysis
      const allDatesSet = new Set([...dopTimeline.map(r => r.date), ...dniTimeline.map(r => r.date)]);
      const allDates = Array.from(allDatesSet).sort();

      let comparisonHtml = `
        <h3 class="text-xl font-semibold mb-2">Date-wise Pay Comparison Analysis</h3>
        <table class="w-full text-sm border">
          <thead>
            <tr>
              <th class="border px-2 py-1">Date</th>
              <th class="border px-2 py-1">DoP Pay (₹)</th>
              <th class="border px-2 py-1">DoP Level</th>
              <th class="border px-2 py-1">DoP Cell</th>
              <th class="border px-2 py-1">DNI Pay (₹)</th>
              <th class="border px-2 py-1">DNI Level</th>
              <th class="border px-2 py-1">DNI Cell</th>
              <th class="border px-2 py-1">Higher Pay</th>
            </tr>
          </thead>
          <tbody>
      `;

      function maxPayEntryOnDate(rows, date) {
        const entries = rows.filter(r => r.date === date);
        if (entries.length === 0) return null;
        return entries.reduce((maxEntry, current) => (current.pay > maxEntry.pay ? current : maxEntry), entries[0]);
      }

      allDates.forEach(date => {
        const dopEntry = maxPayEntryOnDate(dopTimeline, date);
        const dniEntry = maxPayEntryOnDate(dniTimeline, date);

        const dopPay = dopEntry ? dopEntry.pay : null;
        const dniPay = dniEntry ? dniEntry.pay : null;

        let higherPayText = 'Equal';
        if (dopPay !== null && dniPay !== null) {
          if (dopPay > dniPay) higherPayText = 'DoP';
          else if (dniPay > dopPay) higherPayText = 'DNI';
        } else if (dopPay !== null) {
          higherPayText = 'DoP only';
        } else if (dniPay !== null) {
          higherPayText = 'DNI only';
        } else {
          higherPayText = 'N/A';
        }

        comparisonHtml += `
          <tr>
            <td class="border px-2 py-1">${date}</td>
            <td class="border px-2 py-1">${dopPay !== null ? '₹' + dopPay.toLocaleString() : '-'}</td>
            <td class="border px-2 py-1">${dopEntry ? dopEntry.level : '-'}</td>
            <td class="border px-2 py-1">${dopEntry ? dopEntry.cell : '-'}</td>
            <td class="border px-2 py-1">${dniPay !== null ? '₹' + dniPay.toLocaleString() : '-'}</td>
            <td class="border px-2 py-1">${dniEntry ? dniEntry.level : '-'}</td>
            <td class="border px-2 py-1">${dniEntry ? dniEntry.cell : '-'}</td>
            <td class="border px-2 py-1 font-semibold">${higherPayText}</td>
          </tr>
        `;
      });

      comparisonHtml += `</tbody></table>`;

      document.getElementById('recommendation').innerHTML = comparisonHtml;
    }

    document.getElementById('calculateBtn').addEventListener('click', calculateFixation);
    document.getElementById('currentLevel').addEventListener('change', updateCells);

    fetch('./pay_matrix_sikkim.csv')
      .then(res => res.text())
      .then(data => parseCSV(data))
      .catch(err => showMessage('Failed to load pay matrix CSV.', 'error'));
  </script>
</body>
</html>
