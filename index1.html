<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sikkim Pay Fixation Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 py-10">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded px-8 py-6">
    <h2 class="text-2xl font-bold mb-4 text-center">Sikkim Government Pay Fixation Calculator</h2>
    <div id="message" class="hidden mb-4 p-4 rounded text-white"></div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block font-medium">Promotion Date</label>
        <input type="date" id="promotionDate" class="w-full p-2 border rounded" />
      </div>
      <div>
        <label class="block font-medium">Current Pay Level</label>
        <select id="currentLevel" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-medium">Current Pay Cell</label>
        <select id="currentCell" class="w-full p-2 border rounded"></select>
      </div>
      <div>
        <label class="block font-medium">Promoted Pay Level</label>
        <select id="promotedLevel" class="w-full p-2 border rounded"></select>
      </div>
    </div>
    <div class="mt-6 text-center">
      <button id="calculateBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Calculate</button>
    </div>

    <div class="mt-8 text-sm text-gray-700 italic">
      <p><strong>Increment Rule:</strong> If promotion occurs between <u>2nd Jan to 1st July</u>, the next increment will be on <u>1st January</u> of the following year. If promotion occurs between <u>2nd July to 1st January</u>, the increment will be on <u>1st July</u> of the following year.</p>
    </div>

    <div id="dopResult" class="mt-8"></div>
    <div id="dniResult" class="mt-8"></div>
    <div id="recommendation" class="mt-8 text-lg font-semibold text-green-700"></div>
  </div>

  <script>
    let payMatrix = {};

    function showMessage(text, type = 'info') {
      const box = document.getElementById('message');
      box.className = `mb-4 p-4 rounded text-white ${type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
      box.textContent = text;
      box.classList.remove('hidden');
      setTimeout(() => box.classList.add('hidden'), 4000);
    }

    function parseCSV(data) {
      Papa.parse(data, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          results.data.forEach(row => {
            const level = row.Level.trim();
            delete row.Level;
            payMatrix[level] = Object.values(row).map(val => parseInt(val, 10)).filter(v => !isNaN(v));
          });
          populateLevels();
        }
      });
    }

    function populateLevels() {
      const currentLevel = document.getElementById('currentLevel');
      const promotedLevel = document.getElementById('promotedLevel');
      currentLevel.innerHTML = promotedLevel.innerHTML = '';
      for (let level in payMatrix) {
        currentLevel.innerHTML += `<option value="${level}">${level}</option>`;
        promotedLevel.innerHTML += `<option value="${level}">${level}</option>`;
      }
      updateCells();
    }

    function updateCells() {
      const level = document.getElementById('currentLevel').value;
      const currentCell = document.getElementById('currentCell');
      currentCell.innerHTML = '';
      if (payMatrix[level]) {
        payMatrix[level].forEach((val, i) => {
          currentCell.innerHTML += `<option value="${i}">${i + 1} - ₹${val}</option>`;
        });
      }
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function getNextIncrementDate(date) {
      const month = date.getMonth();
      const year = date.getFullYear() + 1;
      return (month < 6 || (month === 6 && date.getDate() <= 1)) ? new Date(`${year}-01-01`) : new Date(`${year}-07-01`);
    }

    function calculateFixation() {
      const promoDateStr = document.getElementById('promotionDate').value;
      if (!promoDateStr) return showMessage('Please enter the promotion date.', 'error');

      const promoDate = new Date(promoDateStr);
      const currLevel = document.getElementById('currentLevel').value;
      const currCell = parseInt(document.getElementById('currentCell').value);
      const promoLevel = document.getElementById('promotedLevel').value;
      const currPay = payMatrix[currLevel][currCell];

      // --- DoP Logic ---
      const dopRows = [];
      const dopIncrCell = Math.min(currCell + 1, payMatrix[currLevel].length - 1);
      const dopIncrPay = payMatrix[currLevel][dopIncrCell];
      let dopFixCell = payMatrix[promoLevel].findIndex(p => p >= dopIncrPay);
      if (dopFixCell === -1) dopFixCell = payMatrix[promoLevel].length - 1;
      const dopFixPay = payMatrix[promoLevel][dopFixCell];
      const dopNextIncrDate = getNextIncrementDate(promoDate);
      const dopNextCell = Math.min(dopFixCell + 1, payMatrix[promoLevel].length - 1);
      const dopNextPay = payMatrix[promoLevel][dopNextCell];

      dopRows.push({ date: formatDate(promoDate), level: currLevel, cell: currCell + 1, pay: currPay, explanation: 'Initial pay before promotion' });
      dopRows.push({ date: formatDate(promoDate), level: currLevel, cell: dopIncrCell + 1, pay: dopIncrPay, explanation: '1 increment in current level' });
      dopRows.push({ date: formatDate(promoDate), level: promoLevel, cell: dopFixCell + 1, pay: dopFixPay, explanation: 'Placed at equal or next higher in promoted level' });
      dopRows.push({ date: formatDate(dopNextIncrDate), level: promoLevel, cell: dopNextCell + 1, pay: dopNextPay, explanation: 'Next Increment Date after DoP' });

      // --- DNI Logic ---
      const dniRows = [];
      let dniInitialCell = payMatrix[promoLevel].findIndex(p => p >= currPay);
      if (dniInitialCell === -1) dniInitialCell = payMatrix[promoLevel].length - 1;
      const dniInitialPay = payMatrix[promoLevel][dniInitialCell];
      const dniEffectiveDate = getNextIncrementDate(promoDate);
      const dniTwoIncrCell = Math.min(currCell + 2, payMatrix[currLevel].length - 1);
      const dniTwoIncrPay = payMatrix[currLevel][dniTwoIncrCell];
      let dniFixCell = payMatrix[promoLevel].findIndex(p => p >= dniTwoIncrPay);
      if (dniFixCell === -1) dniFixCell = payMatrix[promoLevel].length - 1;
      const dniFixPay = payMatrix[promoLevel][dniFixCell];
      const dniNextIncrDate = getNextIncrementDate(dniEffectiveDate);
      const dniNextCell = Math.min(dniFixCell + 1, payMatrix[promoLevel].length - 1);
      const dniNextPay = payMatrix[promoLevel][dniNextCell];

      dniRows.push({ date: formatDate(promoDate), level: promoLevel, cell: dniInitialCell + 1, pay: dniInitialPay, explanation: 'Initial placement in promoted level' });
      dniRows.push({ date: formatDate(dniEffectiveDate), level: currLevel, cell: dniTwoIncrCell + 1, pay: dniTwoIncrPay, explanation: '2 increments in old level (annual + promotional)' });
      dniRows.push({ date: formatDate(dniEffectiveDate), level: promoLevel, cell: dniFixCell + 1, pay: dniFixPay, explanation: 'Placed at next higher in promoted level' });
      dniRows.push({ date: formatDate(dniNextIncrDate), level: promoLevel, cell: dniNextCell + 1, pay: dniNextPay, explanation: 'Next Increment Date after DNI' });

      const renderTable = (title, rows) => {
        return `
          <h3 class="text-xl font-semibold mb-2">${title}</h3>
          <table class="w-full text-sm border">
            <thead><tr><th class="border px-2 py-1">Date</th><th class="border px-2 py-1">Pay Level</th><th class="border px-2 py-1">Cell</th><th class="border px-2 py-1">Basic Pay (₹)</th><th class="border px-2 py-1">Explanation</th></tr></thead>
            <tbody>
              ${rows.map(r => `<tr><td class="border px-2 py-1">${r.date}</td><td class="border px-2 py-1">${r.level}</td><td class="border px-2 py-1">${r.cell}</td><td class="border px-2 py-1">₹${r.pay.toLocaleString()}</td><td class="border px-2 py-1">${r.explanation}</td></tr>`).join('')}
            </tbody>
          </table>
        `;
      };

      document.getElementById('dopResult').innerHTML = renderTable('Fixation from Date of Promotion (DoP)', dopRows);
      document.getElementById('dniResult').innerHTML = renderTable('Fixation from Date of Next Increment (DNI)', dniRows);

      const recommendation = document.getElementById('recommendation');
      const finalDoPPay = dopRows[dopRows.length - 1].pay;
      const finalDNIPay = dniRows[dniRows.length - 1].pay;
      if (finalDoPPay > finalDNIPay) recommendation.innerHTML = `<div class='mt-4 p-4 bg-yellow-50 border border-yellow-300 rounded'>
        <strong></strong><br>
        <span class='text-sm text-gray-700'>Cumulative benefit over time is based on your priority: immediate gains (DoP) or higher later increments (DNI).</span>
      </div>`;
      else if (finalDoPPay < finalDNIPay) recommendation.innerText = '✅ Recommendation: DNI is more beneficial only if you prioritize higher future increments, despite delayed benefit.';
      else recommendation.innerText = '✅ Recommendation: Both options offer the same benefit.';
    }

    document.getElementById('calculateBtn').addEventListener('click', calculateFixation);
    document.getElementById('currentLevel').addEventListener('change', updateCells);

    fetch('pay_matrix_sikkim.csv')
      .then(res => res.text())
      .then(data => parseCSV(data))
      .catch(err => showMessage('Failed to load pay matrix CSV.', 'error'));
  </script>
<canvas id="comparisonChart" class="mt-12"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function drawChart(dopRows, dniRows) {
  const ctx = document.getElementById('comparisonChart').getContext('2d');
  const labels = Array.from(new Set([...dopRows, ...dniRows].map(r => r.date))).sort();
  const dopData = labels.map(date => {
    const match = dopRows.find(r => r.date === date);
    return match ? match.pay : null;
  });
  const dniData = labels.map(date => {
    const match = dniRows.find(r => r.date === date);
    return match ? match.pay : null;
  });
  // Calculate cumulative pay arrays
  let dopTotal = 0;
  let dniTotal = 0;
  const dopCumulative = labels.map(date => {
    const match = dopRows.find(r => r.date === date);
    if (match) dopTotal += match.pay;
    return dopTotal;
  });
  const dniCumulative = labels.map(date => {
    const match = dniRows.find(r => r.date === date);
    if (match) dniTotal += match.pay;
    return dniTotal;
  });

  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'DoP (Basic Pay)',
          data: dopData,
          borderColor: 'rgba(59, 130, 246, 1)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.3,
          fill: true
        },
        {
          label: 'DNI (Basic Pay)',
          data: dniData,
          borderColor: 'rgba(16, 185, 129, 1)',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.3,
          fill: true
        },
        {
          label: 'DoP (Cumulative)',
          data: dopCumulative,
          borderColor: 'rgba(59, 130, 246, 0.6)',
          borderDash: [5, 5],
          fill: false,
          tension: 0.3
        },
        {
          label: 'DNI (Cumulative)',
          data: dniCumulative,
          borderColor: 'rgba(16, 185, 129, 0.6)',
          borderDash: [5, 5],
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Pay Progression Comparison Over Time' }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: { display: true, text: 'Basic Pay (₹)' }
        },
        x: {
          title: { display: true, text: 'Date' }
        }
      }
    }
  });
}
</script>
<script>
  const originalCalc = calculateFixation;
  calculateFixation = function () {
    originalCalc();
    setTimeout(() => {
      drawChart(
        dopRows,
        dniRows
      );
    }, 100);
  };
</script>
</body>
</html>
